name: Migration Engine
on:
  push:

jobs:


  test:
    name: "Test Migration Engine - vttestserver"

    services:
      vttestserver57:
        image: vitess/vttestserver:mysql57
        ports:
          - 33577:33577
        env:
          PORT: 33574
          KEYSPACES: apply_migrations_with_an_empty_migrations_folder_works,applying_a_single_migration_should_work,applying_two_migrations_works,migrations_should_fail_when_the_script_is_invalid,migrations_should_not_reapply_modified_migrations,migrations_should_fail_on_an_uninitialized_nonempty_database,migrations_should_succeed_on_an_uninitialized_nonempty_database_with_postgis_tables,basic_create_migration_works,creating_a_second_migration_should_have_the_previous_sql_schema_as_baseline,bad_migrations_should_make_the_command_fail_with_a_good_error,empty_migrations_should_not_be_created,migration_name_length_is_validated,empty_migrations_should_be_created_with_the_draft_option,creating_a_migration_with_a_non_existent_migrations_directory_should_work,create_enum_step_only_rendered_when_needed,create_enum_renders_correctly,unsupported_type_renders_correctly,no_additional_unique_created,diagnose_migrations_history_on_an_empty_database_without_migration_returns_nothing,diagnose_migrations_history_after_two_migrations_happy_path,diagnose_migration_history_with_opt_in_to_shadow_database_calculates_drift,diagnose_migration_history_without_opt_in_to_shadow_database_does_not_calculate_drift,diagnose_migration_history_calculates_drift_in_presence_of_failed_migrations,diagnose_migrations_history_can_detect_when_the_database_is_behind,diagnose_migrations_history_can_detect_when_the_folder_is_behind,diagnose_migrations_history_can_detect_when_history_diverges,diagnose_migrations_history_can_detect_edited_migrations,diagnose_migrations_history_reports_migrations_failing_to_apply_cleanly,diagnose_migrations_history_with_a_nonexistent_migrations_directory_works,with_a_failed_migration,with_an_invalid_unapplied_migration_should_report_it,drift_can_be_detected_without_migrations_table,shadow_database_creation_error_is_special_cased_mysql,shadow_database_creation_error_is_special_cased_postgres,shadow_database_creation_error_is_special_cased_mssql,empty_migration_directories_should_cause_known_errors,authentication_failure_must_return_a_known_error_on_postgres,authentication_failure_must_return_a_known_error_on_mysql,unreachable_database_must_return_a_proper_error_on_mysql,unreachable_database_must_return_a_proper_error_on_postgres,database_does_not_exist_must_return_a_proper_error,database_access_denied_must_return_a_proper_error_in_rpc,bad_datasource_url_and_provider_combinations_must_return_a_proper_error,connections_to_system_databases_must_be_rejected,datamodel_parser_errors_must_return_a_known_error,unique_constraint_errors_in_migrations_must_return_a_known_error,json_fields_must_be_rejected,connection_string_problems_give_a_nice_error,evaluate_data_loss_with_an_up_to_date_database_returns_no_step,evaluate_data_loss_with_up_to_date_db_and_pending_changes_returns_steps,evaluate_data_loss_with_not_up_to_date_db_and_pending_changes_returns_the_right_steps,evaluate_data_loss_with_past_unapplied_migrations_with_destructive_changes_does_not_warn_for_these,evaluate_data_loss_returns_warnings_for_the_local_database_for_the_next_migration,evaluate_data_loss_maps_warnings_to_the_right_steps,dropping_a_table_with_rows_should_warn,dropping_a_column_with_non_null_values_should_warn,altering_a_column_without_non_null_values_should_not_warn,altering_a_column_with_non_null_values_should_warn,column_defaults_can_safely_be_changed,changing_a_column_from_required_to_optional_should_work,changing_a_column_from_optional_to_required_is_unexecutable,dropping_a_table_referenced_by_foreign_keys_must_work,string_columns_do_not_get_arbitrarily_migrated,altering_the_type_of_a_column_in_an_empty_table_should_not_warn,making_a_column_required_in_an_empty_table_should_not_warn,enum_variants_can_be_added_without_data_loss,enum_variants_can_be_dropped_without_data_loss,set_default_current_timestamp_on_existing_column_works,primary_key_migrations_do_not_cause_data_loss,failing_enum_migrations_should_not_be_partially_applied,adding_a_required_field_to_an_existing_table_with_data_without_a_default_is_unexecutable,adding_a_required_field_with_prisma_level_default_works,adding_a_required_field_with_a_default_to_an_existing_table_works,adding_a_required_field_without_default_to_an_existing_table_without_data_works,adding_a_unique_constraint_should_warn,dropping_enum_values_should_warn,adding_a_unique_constraint_when_existing_data_respects_it_works,making_an_optional_field_required_with_data_without_a_default_is_unexecutable,making_an_optional_field_required_with_data_with_a_default_works,making_an_optional_field_required_with_data_with_a_default_is_unexecutable,making_an_optional_field_required_on_an_empty_table_works,changing_a_column_from_optional_to_required_with_a_default_is_safe,altering_the_type_of_a_column_in_a_non_empty_table_warns,migrating_a_required_column_from_int_to_string_should_cast,changing_a_string_array_column_to_scalar_is_fine,changing_an_int_array_column_to_scalar_is_not_possible,int_to_string_conversions_work,string_to_int_conversions_are_risky,datetime_to_float_conversions_are_impossible,adding_a_model_for_an_existing_table_must_work,removing_a_model_for_a_table_that_is_already_deleted_must_work,creating_a_field_for_an_existing_column_with_a_compatible_type_must_work,creating_a_field_for_an_existing_column_and_changing_its_type_must_work,creating_a_field_for_an_existing_column_and_simultaneously_making_it_optional,creating_a_scalar_list_field_for_an_existing_table_must_work,delete_a_field_for_a_non_existent_column_must_work,deleting_a_scalar_list_field_for_a_non_existent_column_must_work,updating_a_field_for_a_non_existent_column,renaming_a_field_where_the_column_was_already_renamed_must_work,existing_enums_are_picked_up
          NUM_SHARDS: 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
          MYSQL_BIND_HOST: "0.0.0.0"
        options: --health-cmd="mysqladmin ping -h127.0.0.1 -P33577" --health-interval=5s --health-timeout=2s --health-retries=20

    runs-on: ubuntu-latest
    steps:
    
      - run: mysql -h 127.0.0.1 -P 33577 -u test -ptest -e "SHOW DATABASES;"
      
      - uses: actions/checkout@v2

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.48.0
          default: true

      - uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: migration-engine-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - run: timeout 40m cargo test mysql_5_6
        working-directory: migration-engine/migration-engine-tests
        env:
          CLICOLOR_FORCE: 1
